---
import { navigation } from "../config/navigation";
import { getSiteMetadata } from "../config/site";
import { getLocalizedPath, locales, ui, useTranslations } from "../i18n/ui";

const { locale } = Astro.props;
const t = useTranslations(locale) as (key: string) => string;
const metadata = getSiteMetadata(locale);
const localeNames = ui as unknown as Record<string, { localeName: string }>;

const languageLinks = locales.map((item) => ({
    locale: item,
    label: localeNames[item].localeName,
    href: getLocalizedPath("/", item),
    isCurrent: item === locale,
}));

const buildHref = (item: { path: string; hash?: string }) => {
    const base = getLocalizedPath(item.path, locale);
    return item.hash ? `${base}${item.hash}` : base;
};

const navId = "global-navigation";
---

<header id={navId} class="p-navigation is-dark">
    <div class="p-navigation__row--25-75">
        <div class="p-navigation__banner">
            <div class="p-navigation__tagged-logo">
                <a
                    class="p-navigation__link"
                    href={getLocalizedPath("/", locale)}
                >
                    <div class="p-navigation__logo-tag">
                        <img
                            class="p-navigation__logo-icon"
                            src="https://assets.ubuntu.com/v1/82818827-CoF_white.svg"
                            alt=""
                        />
                    </div>
                    <span class="p-navigation__logo-title"
                        >{metadata.title}</span
                    >
                </a>
            </div>
            <a
                href={`#${navId}`}
                class="p-navigation__toggle--open"
                title={t("navMenu")}
            >
                {t("navMenu")}
            </a>
            <a
                href="#navigation-closed"
                class="p-navigation__toggle--close"
                title={t("navClose")}
            >
                {t("navClose")}
            </a>
        </div>
        <nav class="p-navigation__nav" aria-label="Main">
            <ul class="p-navigation__items">
                {
                    navigation.primary.map((item, index) =>
                        "items" in item ? (
                            <li
                                class="p-navigation__item--dropdown-toggle"
                                id={`nav-dropdown-${index}`}
                            >
                                <a
                                    href={`#nav-dropdown-${index}-menu`}
                                    aria-controls={`nav-dropdown-${index}-menu`}
                                    class="p-navigation__link"
                                >
                                    {t(item.key)}
                                </a>
                                <ul
                                    class={
                                        "align" in item &&
                                        item.align === "right"
                                            ? "p-navigation__dropdown--right"
                                            : "p-navigation__dropdown"
                                    }
                                    id={`nav-dropdown-${index}-menu`}
                                    aria-hidden="true"
                                >
                                    {item.items.map((child) => (
                                        <li>
                                            <a
                                                class="p-navigation__dropdown-item"
                                                href={buildHref(child)}
                                            >
                                                {t(child.key)}
                                            </a>
                                        </li>
                                    ))}
                                </ul>
                            </li>
                        ) : (
                            <li class="p-navigation__item">
                                <a
                                    class="p-navigation__link"
                                    href={buildHref(item)}
                                >
                                    {t(item.key)}
                                </a>
                            </li>
                        ),
                    )
                }
            </ul>
            <ul class="p-navigation__items">
                {
                    languageLinks.map((link) => (
                        <li class="p-navigation__item">
                            <a
                                class="p-navigation__link"
                                aria-current={
                                    link.isCurrent ? "page" : undefined
                                }
                                href={link.href}
                            >
                                {link.label}
                            </a>
                        </li>
                    ))
                }
            </ul>
        </nav>
    </div>
</header>

<script is:inline>
    // @ts-nocheck
    function toggleDropdown(toggle, open) {
        var parentElement = toggle.parentNode;
        var dropdown = document.getElementById(
            toggle.getAttribute("aria-controls"),
        );
        if (!dropdown) {
            return;
        }

        dropdown.setAttribute("aria-hidden", !open);

        if (open) {
            parentElement.classList.add("is-active");
        } else {
            parentElement.classList.remove("is-active");
        }
    }

    function closeAllDropdowns(toggles) {
        toggles.forEach(function (toggle) {
            toggleDropdown(toggle, false);
        });
    }

    function handleClickOutside(toggles, containerClass) {
        document.addEventListener("click", function (event) {
            var target = event.target;

            if (target.closest) {
                if (!target.closest(containerClass)) {
                    closeAllDropdowns(toggles);
                }
            }
        });
    }

    function initNavDropdowns(containerClass) {
        var toggles = [].slice.call(
            document.querySelectorAll(containerClass + " [aria-controls]"),
        );

        handleClickOutside(toggles, containerClass);

        toggles.forEach(function (toggle) {
            toggle.addEventListener("click", function (event) {
                event.preventDefault();

                var shouldOpen =
                    !toggle.parentNode.classList.contains("is-active");
                closeAllDropdowns(toggles);
                toggleDropdown(toggle, shouldOpen);
            });
        });
    }

    initNavDropdowns(".p-navigation__item--dropdown-toggle");
</script>
